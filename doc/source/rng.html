<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">// Random number generator - requires a PRNG backend, e.g. prng4.js

// For best results, put code like
// &lt;body onClick='SecureRandom.seedTime();' onKeyPress='SecureRandom.seedTime();'&gt;
// in your main HTML document.

/*jslint bitwise: true, white: true */
/*global PRNG */

(function () {
    var rng_state;
    var rng_pool;
    var rng_pptr;
    var rng_psize = PRNG.psize;

<span id='SecureRandom'>    /**
</span>     * SecureRandom class
     */
    function SecureRandom() {}

    // Mix in a 32-bit integer into the pool
    function rng_seed_int(x) {
      rng_pool[rng_pptr++] ^= x &amp; 255;
      rng_pool[rng_pptr++] ^= (x &gt;&gt; 8) &amp; 255;
      rng_pool[rng_pptr++] ^= (x &gt;&gt; 16) &amp; 255;
      rng_pool[rng_pptr++] ^= (x &gt;&gt; 24) &amp; 255;
      if(rng_pptr &gt;= rng_psize) rng_pptr -= rng_psize;
    }

<span id='SecureRandom-static-method-seedTime'>    /**
</span>     * Mix in the current time (w/milliseconds) into the pool
     * @method seedTime
     * @static
     */
    function rng_seed_time() {
        rng_seed_int(new Date().getTime());
    }

    function rng_get_byte() {
      if(rng_state == null) {
        rng_seed_time();
        rng_state = PRNG.newstate();
        rng_state.init(rng_pool);
        for(rng_pptr = 0; rng_pptr &lt; rng_pool.length; ++rng_pptr)
          rng_pool[rng_pptr] = 0;
        rng_pptr = 0;
        //rng_pool = null;
      }
      // TODO: allow reseeding after first request
      return rng_state.next();
    }

    function rng_get_bytes(ba) {
      var i;
      for(i = 0; i &lt; ba.length; ++i) ba[i] = rng_get_byte();
    }

    SecureRandom.prototype.nextBytes = rng_get_bytes;
    SecureRandom.seedTime = rng_seed_time;

    // Initialize the pool with junk if needed.
    if(rng_pool == null) {
      rng_pool = new Array();
      rng_pptr = 0;
      var t;
      if(window.crypto &amp;&amp; window.crypto.getRandomValues) {
        // Use webcrypto if available
        var ua = new Uint8Array(32);
        window.crypto.getRandomValues(ua);
        for(t = 0; t &lt; 32; ++t)
          rng_pool[rng_pptr++] = ua[t];
      }
      if(navigator.appName == &quot;Netscape&quot; &amp;&amp; navigator.appVersion &lt; &quot;5&quot; &amp;&amp; window.crypto) {
        // Extract entropy (256 bits) from NS4 RNG if available
        var z = window.crypto.random(32);
        for(t = 0; t &lt; z.length; ++t)
          rng_pool[rng_pptr++] = z.charCodeAt(t) &amp; 255;
      }
      while(rng_pptr &lt; rng_psize) {  // extract some randomness from Math.random()
        t = Math.floor(65536 * Math.random());
        rng_pool[rng_pptr++] = t &gt;&gt;&gt; 8;
        rng_pool[rng_pptr++] = t &amp; 255;
      }
      rng_pptr = 0;
      rng_seed_time();
      //rng_seed_int(window.screenX);
      //rng_seed_int(window.screenY);
    }

    //For browsers
    window.SecureRandom = SecureRandom;
}());
</pre>
</body>
</html>
